var myApp=angular.module("myApp",["textAngular","ngRoute","infinite-scroll"]);myApp.config(["$httpProvider",function(o){o.defaults.headers.common["X-CSRF-Token"]=$("meta[name=csrf-token]").attr("content")}]),myApp.factory("socket",["$rootScope",function(o){return{on:function(e,t){socket.on(e,function(){var e=arguments;o.$apply(function(){t&&t.apply(socket,e)})})},emit:function(e,t,s){socket.emit(e,t,function(){var e=arguments;o.$apply(function(){s&&s.apply(socket,e)})})}}}]),myApp.factory("UsersFactory",["$http","socket",function(o,e){var t=[],s=[],n={};return n.getEntries=function(e){o.get("/entries").success(function(o){for(var s=0;s<o.entries.length;s++)for(var n=0;n<o.location.length;n++)o.entries[s].entry_location_id==o.location[n].id&&(o.entries[s].city=o.location[n].city,o.entries[s].country=o.location[n].country);t=o.entries,e(t)})},n.getPosts=function(e){o.get("/get_posts").success(function(o){for(console.log("data from get posts",o),s=o.post,t=0;t<s.length;t++)for(n=0;n<o.joy_count.length;n++)s[t].id==o.joy_count[n].post_id&&(s[t].clicked=!0);for(var t=0;t<s.length;t++)for(var n=0;n<o.location.length;n++)s[t].location_id==o.location[n].id&&(s[t].city=o.location[n].city,s[t].country=o.location[n].country);e(s,o.user)})},n.deletePosts=function(o){var t=new Date,n=Math.floor(Date.parse(t)/6e4);for(i in s){var r=Math.floor(Date.parse(s[i].created_at)/6e4);if(n-r>=1440){var c=s[i].id;s.splice(i,1),e.emit("client:limbo_room",{room_number:c})}}o(s)},n.getMessages=function(e){o.get("/get_messages").success(function(o){messages=o,e(messages)})},n}]),myApp.controller("UserController",["$scope","UsersFactory",function(o,e){var t;e.getEntries(function(e){o.entries=[],t=e,t.sort(function(o,e){return o.id-e.id}),console.log("sorted all_entries",t);var s=0;s=t.length>5?5:t.length;for(var n=0;s>n;n++)o.entries.push(t[n])}),o.loadMore=function(){if(o.entries)for(var e=o.entries.length,s=e;e+1>s&&o.entries.length!=t.length&&void 0!=t[s];s++)o.entries.push(t[s])}}]),myApp.controller("PostsController",["$scope","UsersFactory","socket","$http",function(o,e,t,s){var n;t.emit("in_all_posts"),t.on("server:message_sent_to",function(e){if(o.user_id==e.user_id){var t=document.getElementById("message_icon"),s=o.user_id;t.innerHTML="<a href='/posts/"+s+"/messages'><span style='color:orange' class='glyphicon glyphicon-envelope'></span></a>"}}),e.getPosts(function(e,t){console.log("getPosts data",e),o.user_id=t,o.posts=[];for(var s=0;s<e.length;s++){var r=Math.floor((Date.parse(new Date)-Date.parse(e[s].created_at))/36e5+e[s].joys);e[s].rank=r,e[s].time_ago=Math.floor((Date.parse(new Date)-Date.parse(e[s].created_at))/36e5)}n=e,n.sort(function(o,e){return e.rank-o.rank});var c=0;c=n.length>5?5:n.length;for(var s=0;c>s;s++)o.posts.push(n[s])}),setInterval(function(){e.deletePosts(function(e){o.posts=e}),o.$apply()},1e4),o.giveJoy=function(e){s.post("./update_post",{post:e}).success(function(s){if("success"==s){console.log("success posting joy",s);for(var n=0;n<o.posts.length;n++)o.posts[n].id==e&&(o.posts[n].joys+=1,o.posts[n].clicked=!0);t.emit("client:give_joy",{id:e});var r=document.getElementById("joy_count");r.innerHTML=parseInt(r.innerHTML)-1}else console.log("error posting joy",s)})},o.joinRoom=function(o){var e;$(document).ready(function(){e=$("#user_name").text(),console.log("user_name",e)}),t.emit("client:join_room",{room:o,name:e})},t.on("server:update_joys",function(e){for(var t=0;t<o.posts.length;t++)o.posts[t].id==e.post&&(o.posts[t].joys+=1)}),o.loadMore=function(){if(o.posts){start=o.posts.length,console.log("start # of posts:",start),console.log("all_posts",n),console.log("$scope.posts before:",o.posts);for(var e=start;start+1>e&&o.posts.length!=n.length&&void 0!=n[e];e++)o.posts.push(n[e]);console.log("$scope.posts after:",o.posts)}}}]),myApp.controller("MessagesController",["$scope","UsersFactory",function(o,e){e.getMessages(function(e){o.messages=e,console.log("UserController $scope.messages",o.messages)})}]),myApp.controller("TextAngularController",["$scope","UsersFactory",function(o){o.submit_diary=function(){console.log("hello from diary post"),console.log("diary_entry.post",o.diary_entry.post)}}]),myApp.config(["$provide",function(o){o.decorator("taOptions",["taRegisterTool","$delegate",function(o,e){for(var t=["colorGold","colorOrange","colorRed","colorFuchsia","colorPurple","colorMaroon","colorNavy","colorBlue","colorAqua","colorLime","colorGreen","colorOlive","colorBlack","colorGray","colorSilver"],s=["gold","orange","red","fuchsia","purple","maroon","navy","blue","aqua","lime","green","olive","black","gray","silver"],n=function(e,t){icon_class="fa fa-square "+t,o(e,{iconclass:icon_class,action:function(){this.$editor().wrapSelection("forecolor",t)}})},r=0;r<t.length;r++)n(t[r],s[r]),e.toolbar[1].push(t[r]);return e}])}]);